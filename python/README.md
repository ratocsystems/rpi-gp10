# RPi-GP10用Pythonサンプルファイル

RPi-GP10用Pythonサンプルファイルの使用方法について説明します。  
Raspberry Piは'Raspberry Pi3 ModelB'、OSは'Raspbian Stretch with desktop(NOOBS:2018-03-14)'で説明します。
サンプルファイルは`sampleGp10.py`です。  

  
***
## 準備
### Raspberry PiにRPi-GP10を接続
[README.md](../setup/README.md)を参考に下記の準備をおこなってください。  
- 'Raspberry Pi'に'RPi-GP10'を接続  
- OS('Raspbian)のアップデート
- GPIO40pinのI2C設定
  

### Pythonサンプルファイルを実行するディレクトリを作成
1. 'mkdir'コマンドを使って'RPi-GP10'という名前のディレクトリを作成します。(ディレクトリ名や作成場所は自由です)
    ```
    $ mkdir RPi-GP10  
    ```

1. 'ls'コマンドを実行して'RPi-GP10'ディレクトリが作成されていること確認します。
    ```
    $ ls  
    ```

1. 'cd'コマンドで'RPi-GP10'ディレクトリに移動します。
    ```
    $ cd RPi-GP10  
    ```  
    
### PythonサンプルファイルをGitHubからダウンロード  
GitHubからPythonサンプルファイルをダウンロードします。
1. sampleGp10.pyをダウンロード
    ```
    $ wget https://github.com/ratocsystems/rpi-gp10/raw/master/python/sampleGp10.py  
    ```  

1. `ls`コマンドを実行してPythonサンプルファイル`sampleGp10.py`がダウンロードされていることを確認します。
    ```
    $ ls  
    sampleGp10.py
    ```
  
***
## Pythonサンプルファイルについて
  
`sampleGp10.py`  

出力端子・入力端子・トリガー入力端子・ストローブ出力端子を制御するPythonサンプルプログラムです。  
サンプルプログラムでは下記の処理を行っています。

1. **初期値の設定**  
    I2CとGPIOの初期値を設定します。  
    - I2C1を使用するためにコネクションオブジェクト取得
    - RPi-GP10を制御するI2Cアドレスを設定  
        デフォルトは`0x20`ですが、基板上のRA1-RA6の実装を変更することで違うI2Cアドレスを設定することができます。
    - ストローブ出力端子用GPIO番号を設定  
        デフォルトはGPIO14ですが、基板上のJP7をJP8に変更することでGPIO12に設定することができます。
    - トリガー入力端子用GPIO番号を設定  
        デフォルトはGPIO15ですが、基板上のJP5をJP6に変更することでGPIO13に設定することができます。
      
1. **RPi-GP10用インターフェースの初期設定**  
    GPIOとI2Cの初期設定を行います。  
    ※<u>ハードウェアに依存する設定ですので変更しないでください。</u>  
    - GPIOをGPIO番号で指定するように設定
    - 絶縁回路用電源をONに設定  
        電源ON後、安定するまで待ちます。
    - ストローブ端子を出力に設定し、初期状態をHighにします。
    - トリガー端子を入力に設定し、初期状態をHighにします。
    - I2Cでポート0を出力・反転なしに設定し、出力端子として使用できるようにします。  
          方向設定: Configurationレジスタ`0x06`に`0x00`(全ビット出力)を書きます。  
          極性    : Polarity Inversionレジスタ`0x04`に`0x00`(全ビット反転なし)を書きます。  
    - I2Cでポート1を入力・反転ありに設定し、入力端子として使用できるようにします。  
          方向設定: Configurationレジスタ`0x07`に`0xFF`(全ビット入力)を書きます。  
          極性    : Polarity Inversionレジスタ`0x05`に`0xFF`(全ビット反転あり)を書きます。  
      
1. **出力端子の制御**  
    8chの出力端子を制御するために、I2CでOutputレジスタ`0x02`に出力chデータを書き込みます。  
    書き込むデータの各ビットが出力端子の各chに対応していますが、<u>反転しますので</u>`High`を出力したいビットを`0`に、`Low`を出力したいビットを`1`に設定してください。  

    |ch7|ch6|ch5|ch4|ch3|ch2|ch1|ch0|  
    |:--:|:--:|:--:|:--:|:--:|:--:|:--:|:--:|  
    |bit7|bit6|bit5|bit4|bit3|bit2|bit1|bit0|  

    `例1) ch7, ch5, ch3をHighにする場合: 01010111b = 0x57`  
    `例2) 全chをLowにする場合: 11111111b = 0xFF`  
    `例3) 全chをHighにする場合: 00000000b = 0x00`  
  
1. **トリガー入力端子の監視**  
    トリガー入力端子に割り当てられたGPIOの状態を監視します。  
    サンプルプログラムでは、`GPIO.add_event_detect`関数と`GPIO.event_detected`関数を使ってトリガーの立ち下がりを監視しています。  
  
1. **入力端子の確認**  
    8chの入力端子の状態を確認するために、I2CでInputレジスタ`0x01`の値を読み取ります。  
    読み取りデータの各ビットが入力端子の各chに対応していますが、<u>反転していますので</u>各ビットが`0`なら`High`、`1`なら`Low`です。  

    |ch7|ch6|ch5|ch4|ch3|ch2|ch1|ch0|  
    |:--:|:--:|:--:|:--:|:--:|:--:|:--:|:--:|  
    |bit7|bit6|bit5|bit4|bit3|bit2|bit1|bit0|  

    `例1) 読み取りデータが0xA4の場合: 0xA4 = 10100100b ch6, ch4, ch3, ch1, ch0がHigh`  
    `例2) 読み取りデータが0xFFの場合: 0xFF = 11111111b 全chがLow`  
    `例3) 読み取りデータが0x00の場合: 0x00 = 00000000b 全chがHigh`  
  
1. **ストローブ出力端子の制御**  
    ストローブ出力端子に割り当てられたGPIOを制御することで、ストローブ信号を出力します。  
    制御するGPIOとストローブ出力は<u>反転して</u>出力します。 (GPIOが`High`の時はストローブ出力は`Low`、GPIOが`Low`の時はストローブ出力は`High`)
    サンプルプログラムでは、入力端子の状態が指定データと同じだった場合`Low`を出力しています。  
      


***
## Pythonサンプルファイルの使い方
サンプルファイルの前に、`python3`をつけて実行します。

引数をつけずにPythonサンプルファイル`sampleGp10.py`を実行すると、入力端子の状態が取得できます。  
`例) 入力端子のch7, ch5, ch1がHighの場合(0x5D 01011101b)`  
~~~
python3 sampleGp10.py  
入力信号: 0x5D
~~~  
  

- **出力端子を制御する**  
    引数に`'-o'`と出力したい出力chデータを設定することで、出力端子制御することができます。(入力端子の状態も取得します)  
    `例) ch3, ch0をHighにしたい場合は、出力chデータを0xF6(11110110b)に設定`  
    ~~~
    python3 sampleGp10.py -o 0xF6  
    0xF6 を出力しました
    入力信号: 0xXX
    ~~~  

- **トリガー検出時に出力端子を制御する**  
    引数に`'-t'`と出力したい出力chデータを設定すると、トリガー信号の立ち下がり検出時に出力端子制御することができます。(入力端子の状態も取得します)  
    > トリガー信号が検出されるまで無限ループします  

    `例) トリガー検出時にch7, ch5, ch3, ch1, ch0をHighにしたい場合は、出力chデータを0x54(01010100b)に設定`  
    ~~~
    python3 sampleGp10.py -t 0x54  
    Trigger!!!
    0xAB を出力しました
    入力信号: 0xXX
    ~~~  

- **指定の入力状態であればストローブ信号を出力する**  
    引数に`'-s'`と入力chデータを設定することで、入力状態が指定の入力chデータと同じであればストローブ信号`Low`を出力します。  
    `例) ch0がHighの場合にストローブ信号を出力したい場合は、入力chデータを0xFE(11111110b)に設定`  
    ~~~
    python3 sampleGp10.py -s 0xFE  
    入力信号: 0xFE
    Strobe!!!
    ~~~  
